<!-- templates/chat/index.html -->
<!DOCTYPE html>
<html>
    <head>
        <title>WebSocket Chat</title>
        <style>
            .status {
                padding: 5px 10px;
                border-radius: 5px;
                margin: 10px 0;
            }
            .connected { background-color: #4CAF50; color: white; }
            .disconnected { background-color: #f44336; color: white; }
            .connecting { background-color: #2196F3; color: white; }
        </style>
    </head>
    <body>
        <h1>Chat Room</h1>
        <div id="connection-status" class="status disconnected">ì—°ê²° ìƒíƒœ: ì—°ê²° ëŠê¹€</div>
        <div id="chat-log"></div>
        <input id="chat-message-input" type="text" size="100">
        <button id="chat-message-input-btn">Send</button>

        <script>
            let reconnectAttempts = 0;
            const maxReconnectAttempts = 5;
            let chatSocket = null;

            function updateConnectionStatus(status, message) {
                const statusDiv = document.querySelector('#connection-status');
                statusDiv.className = `status ${status}`;
                statusDiv.textContent = `ì—°ê²° ìƒíƒœ: ${message}`;
            }

            function connectWebSocket() {
                updateConnectionStatus('connecting', 'ì—°ê²° ì‹œë„ ì¤‘...');
                
                // HTTPì™€ HTTPSì— ë”°ë¼ ws:// ë˜ëŠ” wss:// ìë™ ì„ íƒ
                const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
                const wsURL = "ws://localhost:8000/ws/chat/";

                <!-- const wsURL = `${wsScheme}://${window.location.host}/ws/chat/`; -->
                console.log(`WebSocket ì—°ê²° ì‹œë„: ${wsURL}`);
                
                chatSocket = new WebSocket(wsURL);

                chatSocket.onopen = function() {
                    console.log('âœ… WebSocket ì—°ê²° ì„±ê³µ');
                    updateConnectionStatus('connected', 'ì—°ê²°ë¨');
                    reconnectAttempts = 0;
                };

                chatSocket.onmessage = function(e) {
                    const data = JSON.parse(e.data);
                    document.querySelector('#chat-log').innerHTML += '<br>' + data.message;
                };

                chatSocket.onclose = function(e) {
                    console.error('â›” WebSocket ì—°ê²° ëŠê¹€:', e.reason);
                    updateConnectionStatus('disconnected', 'ì—°ê²° ëŠê¹€');
                    
                    if (reconnectAttempts < maxReconnectAttempts) {
                        const delay = Math.min(1000 * Math.pow(2, reconnectAttempts), 10000);
                        console.log(`${delay / 1000}ì´ˆ í›„ ì¬ì—°ê²° ì‹œë„...`);
                        setTimeout(connectWebSocket, delay);
                        reconnectAttempts++;
                    } else {
                        updateConnectionStatus('disconnected', 'ì¬ì—°ê²° ì‹¤íŒ¨. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•˜ì„¸ìš”.');
                    }
                };

                chatSocket.onerror = function(err) {
                    console.error('ğŸ”¥ WebSocket ì—ëŸ¬ ë°œìƒ:', err);
                    updateConnectionStatus('disconnected', 'ì—°ê²° ì—ëŸ¬');
                };
            }

            connectWebSocket();

            document.querySelector('#chat-message-input-btn').onclick = function() {
                const messageInputDom = document.querySelector('#chat-message-input');
                const message = messageInputDom.value;

                if (chatSocket && chatSocket.readyState === WebSocket.OPEN) {
                    chatSocket.send(JSON.stringify({'message': message}));
                    messageInputDom.value = '';
                } else {
                    alert('ì„œë²„ì™€ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                }
            };

            document.querySelector('#chat-message-input').onkeyup = function(e) {
                if (e.keyCode === 13) {
                    document.querySelector('#chat-message-input-btn').click();
                }
            };
        </script>
    </body>
</html>
